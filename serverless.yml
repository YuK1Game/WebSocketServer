service: websocket

plugins:
    - ./vendor/bref/bref
    - serverless-dotenv-plugin

provider:
    name: aws
    region: ap-northeast-1
    stage: ${env:APP_ENV}
    runtime: provided.al2
    profile: yuk1
    environment:
        REDIS_HOST:
            "Fn::GetAtt": [CacheCluster, RedisEndpoint.Address]

custom:
    description: "${self:service} Project"
    dotenv:
        include:
            - APP_ENV
            - REDIS_PORT

package:
    exclude:
        - node_modules/**
        - public/storage
        - resources/assets/**
        - storage/**
        - tests/**

functions:
    web:
        handler: public/index.php
        timeout: 28
        layers:
            - ${bref:layer.php-80-fpm}
        events:
            - httpApi: '*'
        warmer: true
            
    artisan:
        handler: artisan
        timeout: 890
        layers:
            - ${bref:layer.php-80}
            - ${bref:layer.console}

    websocket:
        handler: websocket
        layers:
            - ${bref:layer.php-80}
            - ${bref:extra.redis-php-80}
        events:
            - websocket: $connect
            - websocket: $disconnect
            - websocket: $default
            - websocket: message

resources:
    - ${file(./.serverless-config/vpc.yml)}
    - ${file(./.serverless-config/private-subnet.yml)}
    - ${file(./.serverless-config/security-group.yml)}
    - ${file(./.serverless-config/cache-cluster.yml)}